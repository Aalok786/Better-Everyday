{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aalok's Habit Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- GITHUB GRID (UPDATED FOR 6 ROWS & BIGGER GAP) --- */
        .github-grid {
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            /* <-- CHANGED TO 6 ROWS */
            grid-auto-flow: column;
            gap: 6px;
            /* <-- INCREASED GAP FOR CLEANER LOOK */
        }
    </style>
</head>

<body class="bg-gray-950 text-white font-sans min-h-screen flex flex-col items-center">

    <nav
        class="hidden md:flex w-full max-w-4xl bg-gray-900/50 backdrop-blur-md border-b border-gray-800 p-4 justify-between items-center sticky top-0 z-50 rounded-b-xl mb-6">
        <div class="flex items-center gap-2 group cursor-pointer">
            <div class="bg-green-500/10 p-2 rounded-lg group-hover:bg-green-500/20 transition-colors">
                <i class="ph-fill ph-plant text-green-500 text-2xl"></i>
            </div>

            <div class="flex flex-col">
                <span class="font-bold text-lg tracking-wide leading-none text-gray-100">Better Everyday</span>
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-semibold">One step at a
                    time</span>
            </div>
        </div>
        <div class="flex gap-6">
            <button onclick="switchTab('home')"
                class="nav-item text-blue-400 font-medium hover:text-blue-300 transition">Home</button>
            <button onclick="switchTab('habits')"
                class="nav-item text-gray-400 font-medium hover:text-white transition">Habits</button>
            <button onclick="switchTab('stats')"
                class="nav-item text-gray-400 font-medium hover:text-white transition">Stats</button>
        </div>
        <div class="text-xs text-gray-500 bg-gray-800 px-3 py-1 rounded-full border border-gray-700">
            {{ today|date:"d M, Y" }}
        </div>
    </nav>

    <div class="w-full max-w-lg md:max-w-2xl px-4 pb-24 md:pb-10 flex-1 overflow-y-auto no-scrollbar">

        <div id="view-home" class="tab-content active space-y-6 animate-fade">

            <div class="mt-2 md:mt-0">
                <h1
                    class="text-3xl md:text-4xl font-bold bg-gradient-to-br from-white to-gray-500 bg-clip-text text-transparent">
                    {{ greeting }} üëã
                </h1>
                <p class="text-gray-400 text-sm mt-1">Ready to win the day?</p>
            </div>

            <div
                class="bg-gray-900 border border-gray-800 p-6 rounded-2xl relative shadow-lg group hover:border-blue-500/30 transition-colors">
                <i
                    class="ph-fill ph-quotes text-4xl text-gray-800 absolute top-4 right-4 group-hover:text-blue-500/20 transition-colors"></i>
                <p id="quote-text" class="text-lg font-light italic text-gray-200">
                    {% if quote %}"{{ quote.text }}"{% else %}"Loading inspiration..."{% endif %}
                </p>
                <p id="quote-author" class="text-xs font-bold text-blue-400 mt-3 uppercase tracking-widest">
                    - {% if quote %}{{ quote.author|default:"Unknown" }}{% endif %}
                </p>
            </div>

            <div
                class="flex flex-col items-center gap-3 bg-gray-900 p-6 rounded-2xl border border-gray-800 w-full max-w-sm mx-auto shadow-xl">

                <div class="flex justify-between items-end w-full mb-2">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Consistency</span>
                    <span class="text-xs text-gray-500">Last 30 Days</span>
                </div>

                <div class="github-grid">
                    {% for day in heatmap_data %}
                    <div title="{{ day.date|date:'d M' }}: {{ day.score }}%"
                        class="w-5 h-5 rounded-md {{ day.color }} {% if day.is_today %} ring-2 ring-white ring-offset-2 ring-offset-gray-900 {% endif %} hover:scale-110 transition-transform cursor-pointer relative group">
                    </div>
                    {% endfor %}
                </div>

                <div class="flex items-center gap-2 text-[10px] text-gray-500 mt-2 justify-center w-full">
                    <span>Less</span>
                    <div class="w-3 h-3 bg-gray-800 rounded-sm"></div>
                    <div class="w-3 h-3 bg-green-900 rounded-sm"></div>
                    <div class="w-3 h-3 bg-green-600 rounded-sm"></div>
                    <div class="w-3 h-3 bg-green-400 rounded-sm"></div>
                    <span>More</span>
                </div>
            </div>

        </div>

        <div id="view-habits" class="tab-content hidden space-y-3 animate-fade">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-xl font-bold">Today's Tasks</h2>
                <div class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-400 border border-gray-700">Priority View
                </div>
            </div>

            {% for item in daily_data %}
            <div
                class="group bg-gray-900 hover:bg-gray-800/80 transition-all p-3 md:p-4 rounded-xl border border-gray-800 flex items-center justify-between shadow-sm hover:shadow-md hover:border-gray-700">
                <div class="flex flex-col">
                    <span class="font-medium text-gray-200 text-sm md:text-base">{{ item.entry.habit.name }}</span>
                    <span class="text-[10px] uppercase font-bold tracking-wider mt-1 flex items-center gap-1">
                        {% if item.streak > 0 %}
                        <span class="text-orange-500">üî• {{ item.streak }} Day Streak</span>
                        {% else %}
                        <span class="text-gray-600">Do it today!</span>
                        {% endif %}
                    </span>
                </div>

                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="entry_id" value="{{ item.entry.id }}">

                    {% if item.entry.habit.habit_type == 'BOOL' %}
                    <button type="submit"
                        class="w-10 h-10 md:w-11 md:h-11 rounded-xl flex items-center justify-center transition-all 
                        {% if item.entry.value_bool %} bg-green-500 text-white shadow-[0_0_12px_rgba(34,197,94,0.4)] scale-105 {% else %} bg-gray-800 text-gray-600 hover:bg-gray-700 {% endif %}">
                        <i
                            class="ph-bold {% if item.entry.value_bool %}ph-check{% else %}ph-circle{% endif %} text-xl"></i>
                    </button>
                    {% elif item.entry.habit.habit_type == 'INT' %}
                    <input type="number" name="value_int" value="{{ item.entry.value_int }}"
                        onchange="this.form.submit()"
                        class="w-16 bg-gray-950 border border-gray-700 rounded-lg p-2 text-center text-sm focus:border-green-500 outline-none">
                    {% elif item.entry.habit.habit_type == 'TEXT' %}
                    <input type="text" name="value_text" value="{{ item.entry.value_text }}" onblur="this.form.submit()"
                        placeholder="Log..."
                        class="w-28 bg-gray-950 border border-gray-700 rounded-lg p-2 text-xs focus:border-green-500 outline-none">
                    {% endif %}
                </form>
            </div>
            {% endfor %}
        </div>

        <div id="view-stats"
            class="tab-content hidden flex flex-col items-center justify-center pt-20 text-center space-y-4">
            <div class="w-24 h-24 bg-gray-900 rounded-full flex items-center justify-center border border-gray-800">
                <i class="ph-duotone ph-chart-polar text-4xl text-purple-500"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-300">Analytics Coming Soon</h2>
            <p class="text-gray-500 text-sm max-w-xs">We are gathering data to build your monthly insights.</p>
        </div>

    </div>

    <div
        class="md:hidden fixed bottom-5 left-5 right-5 bg-gray-900/90 backdrop-blur-xl border border-gray-700/50 rounded-2xl shadow-2xl p-2 flex justify-around items-center z-50">
        <button onclick="switchTab('home')" id="btn-home"
            class="nav-btn active flex flex-col items-center gap-1 p-2 rounded-xl text-blue-400">
            <i class="ph-fill ph-house text-2xl"></i>
        </button>
        <button onclick="switchTab('habits')" id="btn-habits"
            class="nav-btn flex flex-col items-center gap-1 p-2 rounded-xl text-gray-500">
            <i class="ph-fill ph-check-square text-2xl"></i>
        </button>
        <button onclick="switchTab('stats')" id="btn-stats"
            class="nav-btn flex flex-col items-center gap-1 p-2 rounded-xl text-gray-500">
            <i class="ph-fill ph-chart-pie-slice text-2xl"></i>
        </button>
    </div>

    <script>
        // --- 1. TAB SWITCHING LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => { el.classList.add('hidden'); el.classList.remove('active'); });
            const activeTab = document.getElementById('view-' + tabName);
            activeTab.classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => { btn.classList.remove('text-blue-400'); btn.classList.add('text-gray-500'); });
            const mobileBtn = document.getElementById('btn-' + tabName);
            if (mobileBtn) { mobileBtn.classList.remove('text-gray-500'); mobileBtn.classList.add('text-blue-400'); }
            document.querySelectorAll('.nav-item').forEach(btn => { btn.classList.remove('text-blue-400'); btn.classList.add('text-gray-400'); });
            if (tabName === 'home') document.querySelectorAll('.nav-item')[0].classList.add('text-blue-400');
            if (tabName === 'habits') document.querySelectorAll('.nav-item')[1].classList.add('text-blue-400');
            if (tabName === 'stats') document.querySelectorAll('.nav-item')[2].classList.add('text-blue-400');
        }

        // --- 2. INTERNET QUOTE FETCHER ---
        async function fetchQuote() {
            const quoteText = document.getElementById('quote-text');
            const quoteAuthor = document.getElementById('quote-author');

            // Fallback Quote (Agar API fail ho jaye)
            const fallbackQuote = {
                text: "Likho kam, Padho jyada!! Padhne se aapki girahein jrur khulengi, likhne ka kya hai,humare bujurg itna kuch likh ke to gayein hain, kabhi kabhi lagta hai ki ab kuch gunjaish hi nahi rahi. Haan agar uske baad bhi lage, tb hi likho!",
                author: "Muntazir Firozaabaadi"
            };

            try {
                // Hum ek fast API use karenge
                const response = await fetch('https://api.api-ninjas.com/v2/randomquotes?category=happiness&categories=wisdom%2Csuccess%2Cphilosophy%2Clife%2Ctruth%2Cfaith%2Chumor%2Ccourage%2Chappiness%2Cwriting%2Ctime%2Cdeath', {
                    headers: { 'X-Api-Key': '08RfLLpKr1gwsoysU4Vj5lChZNXFe8jhGgRki4X1' } // Ya simple Quotable use karein
                });
                // Abhi ke liye simple logic: Agar 3 second mein response nahi aaya, fallback dikhao
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);

                const res = await fetch('https://api.quotable.io/random', { signal: controller.signal });
                const data = await res.json();

                quoteText.innerText = `"${data.content}"`;
                quoteAuthor.innerText = `- ${data.author}`;
            } catch (error) {
                // Internet slow hai ya API down hai, toh ye dikhao:
                quoteText.innerText = `"${fallbackQuote.text}"`;
                quoteAuthor.innerText = `- ${fallbackQuote.author}`;
            }
        }
    </script>

    <script>
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = "{% static 'tracker/manifest.json' %}";
        document.head.appendChild(link);

        function askNotificationPermission() {
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notification");
            } else if (Notification.permission !== "denied" && Notification.permission !== "granted") {
                Notification.requestPermission().then((permission) => {
                    if (permission === "granted") new Notification("Awesome! Notifications are ON. üî•");
                });
            }
        }
        setInterval(() => {
            const now = new Date();
            const hours = now.getHours(); const minutes = now.getMinutes();
            if (hours === 6 && minutes === 0) showNotification("Rise & Shine! ‚òÄÔ∏è", "Time to wake up and conquer the day!");
            if (hours === 20 && minutes === 0) showNotification("Study Time üìö", "Focus now to relax later.");
            if (hours === 22 && minutes === 0) showNotification("Track Your Day üî•", "Don't break the streak! Log your habits.");
        }, 60000);

        function showNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/4315/4315445.png" });
            }
        }
        document.body.addEventListener('click', askNotificationPermission, { once: true });
    </script>
</body>

</html>